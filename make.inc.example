###### Local configuration:

CUDA_INSTALL_PATH = /usr/local/cuda

CPU_ARCH = x86_64   # x86 or x86_64
GPU_ARCH = sm_13    # sm_10, sm_11, sm_12, or sm_13
GPU_EMU  = false    # set to 'true' for device emulation

PYTHON = python     # python 2.5 or later required for 'make gen'
DEVICE = 0          # CUDA device to use for 'make tune'

BUILD_3D = false      # set to 'true' to build 3D Dslash
BUILD_QMP = true      # set to 'true' to build the QMP multi-GPU code
OVERLAP_COMMS = true  # set to 'true' to overlap comms and compute

FECC = gcc	      # Front end CC
FECXX = g++           # Front end CXX

OMPI_HOME=/usr/mpi/gcc/openmpi-1.3.2
QMP_HOME=/home/bjoo/Devel/QCD/install/qmp/qmp2-1-6/openmpi
#OMPI_HOME=/usr/lib64/openmpi/1.3.2-gcc
#QMP_HOME=/home/rbabich/lqcd/install/qmp
#QMP_HOME=/home/mikec/install

######

MPICC=$(OMPI_HOME)/bin/mpicc
MPICXX=$(OMPI_HOME)/bin/mpicxx
QMP_CFLAGS=$(shell $(QMP_HOME)/bin/qmp-config --cflags)
QMP_LDFLAGS=$(shell $(QMP_HOME)/bin/qmp-config --ldflags)
QMP_LIBS=$(shell $(QMP_HOME)/bin/qmp-config --libs)

INC = -I$(CUDA_INSTALL_PATH)/include

CUDA_VERSION = $(shell awk '/\#define CUDA_VERSION/{print $$3}' \
                           $(CUDA_INSTALL_PATH)/include/cuda.h)
OPT = -DCUDA_VERSION=$(CUDA_VERSION)
OPT += -D__CUDA_ARCH__=$(GPU_ARCH:sm_%=%0)

ifeq ($(strip $(CPU_ARCH)), x86_64)
  LIB = -L$(CUDA_INSTALL_PATH)/lib64 -lcudart # for release 2.3 and later
  # LIB = -L$(CUDA_INSTALL_PATH)/lib -lcudart # for release 2.2 and earlier
  COPT =
else
  LIB = -L$(CUDA_INSTALL_PATH)/lib -lcudart
  COPT = -malign-double
endif

ifeq ($(strip $(GPU_EMU)), true)
  COPT += -D__DEVICE_EMULATION__
  NVCCOPT = -deviceemu
endif

ifeq ($(strip $(BUILD_3D)), true)
  OPT += -DBUILD_3D_DSLASH
endif

ifeq ($(strip $(OVERLAP_COMMS)), true)
  OPT += -DOVERLAP_COMMS
endif

COPT += $(OPT)
NVCCOPT += $(OPT)

ifeq ($(strip $(BUILD_QMP)), true)
  RUN = $(OMPI_HOME)/bin/mpirun -np 1
  CC = $(MPICC)
  CXX = $(MPICXX)
  INC += -DQMP_COMMS $(QMP_CFLAGS)
  LIB += $(QMP_LDFLAGS) $(QMP_LIBS)
else 
  RUN =
  CC  = $(FECC)
  CXX = $(FECXX)
endif

CFLAGS = -Wall -O3 -std=c99 $(COPT) $(INC)
CXXFLAGS = -Wall -O3 $(COPT) $(INC)
NVCC = $(CUDA_INSTALL_PATH)/bin/nvcc 
NVCCFLAGS = -O3 $(NVCCOPT) -arch=$(GPU_ARCH) $(INC)
LDFLAGS = -fPIC $(LIB)
